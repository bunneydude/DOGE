// Generated by CoffeeScript 1.6.3
(function() {
  var app, fs, generateChartData, getUpdateData, io,  server, __dirname;

  var express = require ('express');
 
  var request = require('request');

  app = express();
  
 

  app.use(require('express').static('../../webserver'));


  fs = require('fs');

  __dirname = '';

  //The main Web UI will created on port 8000 
  var webserver = app.listen(8000,function(){
    console.log("Server started on port 8000");
   });

  //Define port that will be used for a socket between the RoutingProcessor and Webserver
  //All Data charting/plotting will happen via messages on this socket
  var chartserver = app.listen(3000, function() {
  });

  //Socket to be used for data charting
  chart_io = require('socket.io')(chartserver);

  //Define port that will be used for a socket between the RoutingProcessor and Webserver
  //All messages for network visualization and user requested changes will happen via messages on this socket
  var graphserver = app.listen(4000, function() {
  });
  
  //Socket to be used for network visualization
  graph_io = require('socket.io')(graphserver);

 
  //Chart labels to be used by chartController.js for rendering the chart. 
  generateChartData = function() {
    var lineChartData;
    return lineChartData = [
      {
        label: 'node2',
        datapoints: []
      }, {
        label: 'node3',
        datapoints: []
      }, {
        label: 'node4',
        datapoints: []
      }, {
        label: 'node5',
        datapoints: []
      }, {
        label: 'node6',
        datapoints: []

      }  , {
        label: 'node7',
        datapoints: []

      }   , {
        label: 'node8',
        datapoints: []

      }   , {
        label: 'node9',
        datapoints: []

      }   , {
        label: 'node10',
        datapoints: []

      }    
    ];
  };

  
//Handle communicatin on socket for Chart related messages
chart_io.sockets.on('connection', function(socket) {
    
    //Clients will join the server in rooms/channels 
    //chartController.js will join as room 'chart'
    socket.on('join', function (data) {
        socket.join(data.socketid);
    });
 
    //On socket init send chart template to chartController.js
    chart_io.to('chart').emit('init', generateChartData());
    console.log('Connected to chart socket ');
   
     
    socket.on('updateComponent', function(data) {});

    //If 'update' message recvd from RoutingProcessor -> Send data to chartController.js for rendering.
    socket.on('update',function(data){
        console.log ('Recvd data from python = '+data);
        data = JSON.parse(data);
        chart_io.to('chart').emit('update',data);

    });


  });


//Handle communicatin on socket for Network Vis related messages
var nw_data; 
var sent_nw_data = 0;

/*initializing the websockets communication , server instance has to be sent as the argument */
graph_io.sockets.on("connection",function(socket){
      
    //Clients will join the server in rooms/channels
    //rpsock is the routing processor socket
    //browswersock is the web browser socket
    socket.on('join', function (data) {
        console.log(data.socketid);
        socket.join(data.socketid);
        //If browser just joined - send it the DOGE network info
        if (data.socketid === 'browsersock' && sent_nw_data == 0) {
          graph_io.to('browsersock').emit("load_network",nw_data);
          console.log('browser connected - sending load n/w data');
          sent_nw_data = 1;
        }
 
    });


    console.log('Socket.io Connection with the client established');
    
    //Handle incoming messages from the browser
    socket.on("message",function(data,callback){
        console.log('Received request from browser:');
        console.log(data);
        graph_io.to('rpsock').emit(data);
    }); 

    //Routing Processor will send the network info as a 'load network message'
    //Handle load network message to render network on vis
    socket.on("load_network",function(data){
        console.log("Received load network");
        nw_data = data;
        sent_nw_data  = 0;
        //Debug
        //data = JSON.parse(data);
        //console.log(data);
    });

    socket.on("confirm",function(data){
        graph_io.to('browsersock').emit("confirm",data);
        console.log("Received confirmation from RP:");
       // Debug
         data = JSON.parse(data);
         console.log(data);
    });
 
});
}).call(this);
